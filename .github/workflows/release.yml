name: Release

on:
    workflow_dispatch:
        inputs:
            version_name:
                description: 'Version override (leave empty to use version from build.gradle.kts)'
                required: false
                type: string

jobs:
    release:
        name: Build and Release
        runs-on: ubuntu-latest

        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Set up JDK 11
                uses: actions/setup-java@v4
                with:
                    java-version: '11'
                    distribution: 'temurin'

            -   name: Setup Gradle
                uses: gradle/actions/setup-gradle@v4

            -   name: Get version name
                id: version
                run: |
                    VERSION_NAME=$(./gradlew -q :app:printVersionName)
                    echo "version=$VERSION_NAME" >> $GITHUB_OUTPUT

            -   name: Decode Keystore
                run: |
                    mkdir -p signing
                    echo "${{ secrets.KEYSTORE }}" | base64 --decode > signing/keystore.jks

            -   name: Run Spotless Check
                run: ./gradlew spotlessCheck

            -   name: Run Detekt Analysis
                run: ./gradlew detekt

            -   name: Build Release APK
                env:
                    SIGNING_STORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
                    SIGNING_KEY_ALIAS: ${{ secrets.SIGNING_KEY_ALIAS }}
                    SIGNING_KEY_PASSWORD: ${{ secrets.SIGNING_KEY_PASSWORD }}
                run: ./gradlew assembleRelease

            -   name: Build Release AAB
                env:
                    SIGNING_STORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
                    SIGNING_KEY_ALIAS: ${{ secrets.SIGNING_KEY_ALIAS }}
                    SIGNING_KEY_PASSWORD: ${{ secrets.SIGNING_KEY_PASSWORD }}
                run: ./gradlew bundleRelease

            -   name: Create GitHub Release
                uses: softprops/action-gh-release@v2
                with:
                    tag_name: v${{ inputs.version_name || steps.version.outputs.version }}
                    name: Release v${{ inputs.version_name || steps.version.outputs.version }}
                    generate_release_notes: true
                    files: |
                        app/build/outputs/apk/release/app-release.apk
                        app/build/outputs/bundle/release/app-release.aab
